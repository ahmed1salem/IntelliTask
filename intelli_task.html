<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntelliTask | إنجاز ذكي</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Cairo for Arabic, Inter for English -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <!-- Ionicons CDN -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <style>
        /* Custom styles to apply fonts based on language */
        body[lang="ar"] { font-family: 'Cairo', sans-serif; }
        body[lang="en"] { font-family: 'Inter', sans-serif; }
        .font-cairo { font-family: 'Cairo', sans-serif; }
        .font-inter { font-family: 'Inter', sans-serif; }

        /* --- Transitions & Animations --- */
        button, a {
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        input, select, textarea {
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        #manual-form-container {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        #manual-form-container:not(.hidden) {
            max-height: 500px; /* Adjust as needed */
            opacity: 1;
        }
        #setup-modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300" lang="ar">

    <!-- =========== SETUP & LOGIN MODAL =========== -->
    <!-- Initially visible, hidden after successful login/setup -->
    <div id="setup-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div id="setup-modal-content" class="bg-slate-800 rounded-lg shadow-xl w-full max-w-md transform transition-all">
            <div class="p-8">
                <h2 class="text-2xl font-bold text-center mb-4 text-white" data-translate-key="setup_title">IntelliTask Setup</h2>

                <!-- Tab Buttons -->
                <div class="flex border-b border-slate-700 mb-6">
                    <button class="tab-btn flex-1 py-2 text-center font-semibold border-b-2 border-sky-500 text-sky-500" data-tab="signin" data-translate-key="signin_tab">Sign In</button>
                    <button class="tab-btn flex-1 py-2 text-center font-semibold text-slate-400" data-tab="signup" data-translate-key="signup_tab">Sign Up</button>
                    <button class="tab-btn flex-1 py-2 text-center font-semibold text-slate-400" data-tab="settings" data-translate-key="settings_tab">Settings</button>
                </div>

                <!-- Error Message Area -->
                <div id="auth-error" class="bg-red-500 text-white text-center p-2 rounded-md mb-4 hidden"></div>

                <!-- Sign In Form -->
                <form id="signin-form" class="tab-content space-y-4">
                    <div>
                        <label for="signin-email" class="block mb-2 text-sm font-medium" data-translate-key="email_label">Email</label>
                        <input type="email" id="signin-email" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="signin-password" class="block mb-2 text-sm font-medium" data-translate-key="password_label">Password</label>
                        <input type="password" id="signin-password" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block w-full p-2.5" required>
                    </div>
                    <button type="submit" class="w-full text-white bg-sky-600 hover:bg-sky-700 focus:ring-4 focus:outline-none focus:ring-sky-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors" data-translate-key="signin_btn">Sign In</button>
                </form>

                <!-- Sign Up Form -->
                <form id="signup-form" class="tab-content space-y-4 hidden">
                    <div>
                        <label for="signup-email" class="block mb-2 text-sm font-medium" data-translate-key="email_label">Email</label>
                        <input type="email" id="signup-email" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="signup-password" class="block mb-2 text-sm font-medium" data-translate-key="password_label">Password</label>
                        <input type="password" id="signup-password" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block w-full p-2.5" required>
                    </div>
                    <button type="submit" class="w-full text-white bg-sky-600 hover:bg-sky-700 focus:ring-4 focus:outline-none focus:ring-sky-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors" data-translate-key="signup_btn">Sign Up</button>
                </form>

                <!-- Settings Form -->
                <div id="settings-form" class="tab-content space-y-4 hidden">
                     <div>
                        <label for="gemini-api-key" class="block mb-2 text-sm font-medium" data-translate-key="gemini_key_label">Gemini API Key</label>
                        <input type="password" id="gemini-api-key" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="firebase-config" class="block mb-2 text-sm font-medium" data-translate-key="firebase_config_label">Firebase Config (JSON)</label>
                        <textarea id="firebase-config" rows="5" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block w-full p-2.5"></textarea>
                    </div>
                    <button id="save-settings-btn" class="w-full text-white bg-sky-600 hover:bg-sky-700 focus:ring-4 focus:outline-none focus:ring-sky-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors" data-translate-key="save_settings_btn">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- =========== MAIN APPLICATION CONTAINER =========== -->
    <!-- Initially hidden, shown after successful login/setup -->
    <div id="app-container" class="hidden max-w-4xl mx-auto p-4">

        <!-- --- HEADER --- -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-white">
                <span data-translate-key="app_title_ar">إنجاز ذكي</span>
                <span class="font-inter" data-translate-key="app_title_en">IntelliTask</span>
            </h1>
            <div>
                <button id="language-toggle" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-md transition-colors" data-translate-key="toggle_language_btn">English</button>
                <button id="signout-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md transition-colors ml-2" data-translate-key="signout_btn">Sign Out</button>
            </div>
        </header>

        <main>
            <!-- --- AI CHAT ASSISTANT --- -->
            <section id="ai-chat-assistant" class="mb-6">
                <h2 class="text-2xl font-bold mb-4" data-translate-key="chat_title">AI Assistant</h2>
                <div class="bg-slate-800 rounded-lg flex flex-col h-96">
                    <!-- Chat History -->
                    <div id="chat-history" class="flex-1 p-4 overflow-y-auto space-y-4">
                        <!-- Messages will be appended here -->
                    </div>
                    <!-- Loading Indicator -->
                    <div id="chat-bubble-loading" class="p-4 hidden">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-sky-500 rounded-full animate-pulse"></div>
                            <div class="w-2 h-2 bg-sky-500 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                            <div class="w-2 h-2 bg-sky-500 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                        </div>
                    </div>
                    <!-- Input Form -->
                    <div class="p-4 border-t border-slate-700">
                        <form id="chat-form" class="flex items-center space-x-2">
                            <input type="text" id="chat-input" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg p-2.5 focus:ring-sky-500 focus:border-sky-500" placeholder="Ask me to add a task or just chat..." autocomplete="off">
                            <button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white rounded-lg p-2.5">
                                <ion-icon name="send" class="text-xl"></ion-icon>
                            </button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- --- MANUAL TASK ADDITION (Collapsible) --- -->
            <section id="manual-task-section" class="mb-6">
                <div>
                    <button id="toggle-manual-form" class="w-full text-left font-bold text-xl mb-2" data-translate-key="manual_form_title">Manual Task Entry</button>
                </div>
                <div id="manual-form-container" class="hidden bg-slate-800 rounded-lg p-4 transition-all duration-300 ease-in-out">
                    <form id="manual-task-form" class="space-y-4">
                        <!-- Task Text -->
                        <div>
                            <label for="task-text" class="block mb-2 text-sm font-medium">Task</label>
                            <input type="text" id="task-text" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg w-full p-2.5" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Priority -->
                            <div>
                                <label for="task-priority" class="block mb-2 text-sm font-medium">Priority</label>
                                <select id="task-priority" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg w-full p-2.5">
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="low">Low</option>
                                </select>
                            </div>
                            <!-- Category -->
                            <div>
                                <label for="task-category" class="block mb-2 text-sm font-medium">Category</label>
                                <input type="text" id="task-category" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg w-full p-2.5">
                            </div>
                            <!-- Deadline -->
                            <div>
                                <label for="task-deadline" class="block mb-2 text-sm font-medium">Deadline</label>
                                <input type="date" id="task-deadline" class="bg-slate-700 border border-slate-600 text-white sm:text-sm rounded-lg w-full p-2.5">
                            </div>
                        </div>
                        <button type="submit" class="w-full text-white bg-sky-600 hover:bg-sky-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Add Task</button>
                    </form>
                </div>
            </section>

            <!-- --- TASK LIST --- -->
            <section id="task-list-section">
                <h2 class="text-2xl font-bold mb-4" data-translate-key="task_list_title">My Tasks</h2>
                <div id="task-list-container" class="space-y-4">
                    <!-- Task items will be rendered here -->
                    <!-- Empty state message placeholder -->
                    <div class="text-center py-8 bg-slate-800 rounded-lg">
                        <p data-translate-key="empty_tasks">No tasks yet. Add one manually or ask the AI!</p>
                    </div>
                </div>
            </section>
        </main>

        <!-- --- FOOTER --- -->
        <footer class="text-center mt-8 py-4 border-t border-slate-700">
            <p class="text-sm text-slate-500" data-translate-key="footer_attribution">Developed by: Ahmed Salem | English Dept., Faculty of Arts, Benha University</p>
        </footer>

    </div>

    <!-- =========== JAVASCRIPT LOGIC =========== -->
    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore,
            collection,
            doc,
            getDoc,
            addDoc,
            getDocs,
            updateDoc,
            deleteDoc,
            query,
            where,
            orderBy,
            limit,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- GLOBAL STATE ---
        let firebaseApp, auth, db;
        let currentUser = null;
        let conversationHistory = [];

        // DOM Elements
        const setupModal = document.getElementById('setup-modal');
        const appContainer = document.getElementById('app-container');
        const authError = document.getElementById('auth-error');

        const signinForm = document.getElementById('signin-form');
        const signupForm = document.getElementById('signup-form');
        const settingsForm = document.getElementById('settings-form');

        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        const geminiApiKeyInput = document.getElementById('gemini-api-key');
        const firebaseConfigInput = document.getElementById('firebase-config');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const signoutBtn = document.getElementById('signout-btn');
        const taskListContainer = document.getElementById('task-list-container');
        const manualTaskForm = document.getElementById('manual-task-form');

        // --- 1. TASK RENDERING & MANAGEMENT ---

        function renderTasks(tasks) {
            taskListContainer.innerHTML = ''; // Clear existing tasks

            if (!tasks || tasks.length === 0) {
                taskListContainer.innerHTML = `
                    <div class="text-center py-8 bg-slate-800 rounded-lg">
                        <p data-translate-key="empty_tasks">${translations[currentLanguage].empty_tasks}</p>
                    </div>`;
                return;
            }

            const priorityStyles = {
                high: 'border-red-500',
                medium: 'border-yellow-500',
                low: 'border-sky-500',
            };

            tasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = `bg-slate-800 p-4 rounded-lg flex items-center justify-between transition-opacity duration-300 border-l-4 ${priorityStyles[task.priority] || 'border-slate-500'}`;
                taskCard.dataset.taskId = task.id;

                if (task.isComplete) {
                    taskCard.classList.add('opacity-50');
                }

                taskCard.innerHTML = `
                    <div class="flex-1">
                        <p class="font-bold text-lg ${task.isComplete ? 'line-through' : ''}">${task.task}</p>
                        <div class="flex items-center space-x-4 text-sm text-slate-400 mt-1">
                            ${task.category ? `<span><ion-icon name="folder-outline"></ion-icon> ${task.category}</span>` : ''}
                            ${task.deadline ? `<span><ion-icon name="calendar-outline"></ion-icon> ${task.deadline}</span>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="toggle-complete-btn p-2 text-2xl text-green-500 hover:text-green-400">
                            <ion-icon name="${task.isComplete ? 'checkmark-circle' : 'ellipse-outline'}"></ion-icon>
                        </button>
                        <button class="delete-btn p-2 text-2xl text-red-500 hover:text-red-400">
                            <ion-icon name="trash-outline"></ion-icon>
                        </button>
                    </div>
                `;
                taskListContainer.appendChild(taskCard);
            });
        }

        // --- 2. FIRESTORE DATA FUNCTIONS ---

        // TASKS
        /**
         * Fetches all tasks for the current user from Firestore and triggers rendering.
         */
        const getTasks = async () => {
            if (!currentUser) return;
            const tasksCol = collection(db, "users", currentUser.uid, "tasks");
            const taskSnapshot = await getDocs(query(tasksCol, orderBy("createdAt", "desc")));
            const tasks = taskSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTasks(tasks);
            console.log("Tasks loaded and rendered:", tasks);
        };

        const addTask = async (taskData) => {
            if (!currentUser) return;
            await addDoc(collection(db, "users", currentUser.uid, "tasks"), {
                ...taskData,
                isComplete: false,
                createdAt: serverTimestamp()
            });
            getTasks(); // Refresh task list
        };

        const updateTask = async (taskId, updatedData) => {
            if (!currentUser) return;
            const taskDoc = doc(db, "users", currentUser.uid, "tasks", taskId);
            await updateDoc(taskDoc, updatedData);
            getTasks(); // Refresh task list
        };

        const deleteTask = async (taskId) => {
            if (!currentUser) return;
            await deleteDoc(doc(db, "users", currentUser.uid, "tasks", taskId));
            getTasks(); // Refresh task list
        };

        // CHAT HISTORY
        const saveChatMessage = async (message) => {
             if (!currentUser) return;
            await addDoc(collection(db, "users", currentUser.uid, "chatHistory"), {
                ...message,
                createdAt: serverTimestamp()
            });
        };

        const getChatHistory = async () => {
            if (!currentUser) return;
            const chatCol = collection(db, "users", currentUser.uid, "chatHistory");
            const q = query(chatCol, orderBy("createdAt", "desc"), limit(20)); // Get last 20 messages
            const chatSnapshot = await getDocs(q);

            conversationHistory = chatSnapshot.docs.map(doc => doc.data()).reverse(); // reverse to get chronological order

            // Render chat history
            chatHistoryContainer.innerHTML = '';
            conversationHistory.forEach(message => renderChatMessage(message));

            console.log("Chat history loaded and rendered.");
        };


        // --- 2. SETTINGS & INITIALIZATION ---

        function saveSettings() {
            try {
                const firebaseConfig = JSON.parse(firebaseConfigInput.value);
                localStorage.setItem('firebaseConfig', JSON.stringify(firebaseConfig));
                localStorage.setItem('geminiApiKey', geminiApiKeyInput.value);
                alert('Settings saved! Please sign in or sign up.');
                location.reload(); // Reload to apply settings
            } catch (error) {
                console.error("Invalid Firebase JSON:", error);
                authError.textContent = 'Error: Invalid Firebase Config JSON.';
                authError.classList.remove('hidden');
            }
        }

        function loadCredentials() {
            const firebaseConfig = localStorage.getItem('firebaseConfig');
            const geminiApiKey = localStorage.getItem('geminiApiKey');
            return {
                firebaseConfig: firebaseConfig ? JSON.parse(firebaseConfig) : null,
                geminiApiKey: geminiApiKey || null
            };
        }

        function initializeFirebaseApp(config) {
            if (!config) {
                console.log("Firebase config not found in localStorage.");
                return false;
            }
            try {
                firebaseApp = initializeApp(config);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);
                console.log("Firebase initialized successfully.");
                return true;
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                authError.textContent = `Firebase initialization failed: ${error.message}`;
                authError.classList.remove('hidden');
                // Make sure settings tab is visible if initialization fails
                switchTab('settings');
                return false;
            }
        }

        // --- 2. UI & AUTH LOGIC ---

        function switchTab(tabName) {
            tabBtns.forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('border-sky-500', 'text-sky-500');
                    btn.classList.remove('text-slate-400');
                } else {
                    btn.classList.remove('border-sky-500', 'text-sky-500');
                    btn.classList.add('text-slate-400');
                }
            });
            tabContents.forEach(content => {
                content.id.includes(tabName) ? content.classList.remove('hidden') : content.classList.add('hidden');
            });
             authError.classList.add('hidden'); // Hide error on tab switch
        }

        function showApp() {
            setupModal.classList.add('hidden');
            appContainer.classList.remove('hidden');
        }

        function showAuth() {
            setupModal.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }

        // --- 4. EVENT LISTENERS ---

        manualTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const taskData = {
                task: document.getElementById('task-text').value,
                priority: document.getElementById('task-priority').value,
                category: document.getElementById('task-category').value,
                deadline: document.getElementById('task-deadline').value
            };
            if (taskData.task) {
                await addTask(taskData);
                manualTaskForm.reset();
                // Optionally collapse the form
                document.getElementById('manual-form-container').classList.add('hidden');
            }
        });

        taskListContainer.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const taskCard = target.closest('[data-task-id]');
            const taskId = taskCard.dataset.taskId;

            if (target.classList.contains('toggle-complete-btn')) {
                const taskSnapshot = await getDoc(doc(db, "users", currentUser.uid, "tasks", taskId));
                const isComplete = !taskSnapshot.data().isComplete;
                await updateTask(taskId, { isComplete });
            }

            if (target.classList.contains('delete-btn')) {
                if (confirm('Are you sure you want to delete this task?')) {
                    await deleteTask(taskId);
                }
            }
        });

        tabBtns.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
        saveSettingsBtn.addEventListener('click', saveSettings);

        signoutBtn.addEventListener('click', () => {
            if (auth) {
                signOut(auth).catch(error => console.error("Sign out error:", error));
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // User will be auto-signed-in, onAuthStateChanged will handle the UI change
            } catch (error) {
                authError.textContent = error.message;
                authError.classList.remove('hidden');
            }
        });

        signinForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                 // onAuthStateChanged will handle the UI change
            } catch (error) {
                authError.textContent = error.message;
                authError.classList.remove('hidden');
            }
        });

        // --- 4. APP INITIALIZATION ---

        /**
         * Main application initializer.
         * Loads credentials, initializes Firebase, and sets up the auth state listener.
         */
        function initApp() {
            setLanguage(currentLanguage); // Set initial language on load
            const { firebaseConfig, geminiApiKey } = loadCredentials();

            if (!firebaseConfig || !geminiApiKey) {
                showAuth();
                switchTab('settings'); // Force user to settings if keys are missing
                authError.textContent = 'Please provide Firebase Config and Gemini API Key.';
                authError.classList.remove('hidden');
                // Populate inputs if they exist, for user convenience
                if(firebaseConfig) firebaseConfigInput.value = JSON.stringify(firebaseConfig, null, 2);
                if(geminiApiKey) geminiApiKeyInput.value = geminiApiKey;
                return;
            }

            // Populate settings fields for transparency
            firebaseConfigInput.value = JSON.stringify(firebaseConfig, null, 2);
            geminiApiKeyInput.value = geminiApiKey;

            if (initializeFirebaseApp(firebaseConfig)) {
                onAuthStateChanged(auth, user => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        currentUser = user;
                        showApp();
                        getTasks();
                        getChatHistory();
                    } else {
                        console.log("User is signed out.");
                        showAuth();
                    }
                });
            } else {
                 showAuth(); // Keep auth modal visible if Firebase init fails
            }
        }

        // --- 5. INTERNATIONALIZATION (I18N) ---

        const translations = {
            en: {
                setup_title: "IntelliTask Setup",
                signin_tab: "Sign In",
                signup_tab: "Sign Up",
                settings_tab: "Settings",
                email_label: "Email",
                password_label: "Password",
                signin_btn: "Sign In",
                signup_btn: "Sign Up",
                gemini_key_label: "Gemini API Key",
                firebase_config_label: "Firebase Config (JSON)",
                save_settings_btn: "Save Settings",
                app_title_ar: "",
                app_title_en: "IntelliTask",
                toggle_language_btn: "العربية",
                signout_btn: "Sign Out",
                chat_title: "AI Assistant",
                manual_form_title: "Manual Task Entry",
                task_list_title: "My Tasks",
                empty_tasks: "No tasks yet. Add one manually or ask the AI!",
                footer_attribution: "Developed by: Ahmed Salem | English Dept., Faculty of Arts, Benha University",
            },
            ar: {
                setup_title: "إعداد IntelliTask",
                signin_tab: "تسجيل الدخول",
                signup_tab: "إنشاء حساب",
                settings_tab: "الإعدادات",
                email_label: "البريد الإلكتروني",
                password_label: "كلمة المرور",
                signin_btn: "تسجيل الدخول",
                signup_btn: "إنشاء حساب",
                gemini_key_label: "مفتاح Gemini API",
                firebase_config_label: "إعدادات Firebase (JSON)",
                save_settings_btn: "حفظ الإعدادات",
                app_title_ar: "إنجاز ذكي",
                app_title_en: "",
                toggle_language_btn: "English",
                signout_btn: "تسجيل الخروج",
                chat_title: "المساعد الذكي",
                manual_form_title: "إدخال مهمة يدوياً",
                task_list_title: "مهامي",
                empty_tasks: "لا توجد مهام بعد. أضف واحدة يدوياً أو اطلب من المساعد الذكي!",
                footer_attribution: "تم التطوير بواسطة: أحمد سالم | قسم اللغة الإنجليزية، كلية الآداب، جامعة بنها",
            }
        };

        let currentLanguage = localStorage.getItem('language') || 'ar';

        function setLanguage(lang) {
            if (lang !== 'ar' && lang !== 'en') return;

            currentLanguage = lang;
            localStorage.setItem('language', lang);

            const direction = lang === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.lang = lang;
            document.documentElement.dir = direction;
            document.body.lang = lang;

            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });

            // Special handling for placeholder attributes if needed in the future
            // Example: document.getElementById('chat-input').placeholder = translations[lang].chat_placeholder;
        }

        document.getElementById('language-toggle').addEventListener('click', () => {
            const newLang = currentLanguage === 'ar' ? 'en' : 'ar';
            setLanguage(newLang);
        });

        document.getElementById('toggle-manual-form').addEventListener('click', () => {
            const formContainer = document.getElementById('manual-form-container');
            // This toggle works with the new CSS to create a smooth collapse/expand animation
            formContainer.classList.toggle('hidden');
        });

        // --- 7. APP INITIALIZATION ---
        const chatHistoryContainer = document.getElementById('chat-history');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const loadingIndicator = document.getElementById('chat-bubble-loading');

        const systemPrompt = `You are a helpful assistant for a smart to-do list app called IntelliTask.
- Your primary function is to help users manage their tasks by understanding natural language.
- When you detect a request to add one or more tasks, you MUST respond ONLY with a valid JSON object that adheres to the provided schema. The JSON object should contain an array of tasks and a concise, encouraging responseMessage.
- A task can have a 'task' (string), 'priority' (string: "high", "medium", "low"), 'category' (string), and 'deadline' (string).
- For general conversation (e.g., "hello", "how are you?"), respond with a friendly conversational message in the responseMessage field and an EMPTY tasks array.
- IMPORTANT: You MUST reply in the same language as the user's last message (either English or Arabic).
- Today's date is ${new Date().toLocaleDateString()}. Use this to interpret deadlines like "tomorrow" or "next Friday".`;

        const responseSchema = {
            type: "object",
            properties: {
                tasks: {
                    type: "array",
                    items: {
                        type: "object",
                        properties: {
                            task: { type: "string" },
                            priority: { type: "string", enum: ["high", "medium", "low"] },
                            category: { type: "string" },
                            deadline: { type: "string" },
                        },
                        required: ["task"]
                    }
                },
                responseMessage: { type: "string" }
            },
            required: ["tasks", "responseMessage"]
        };

        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        console.warn(`Rate limited. Retrying in ${delay / 1000}s... (${retries} retries left)`);
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithBackoff(url, options, retries - 1, delay * 2);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            } catch (error) {
                console.error("Fetch error:", error);
                throw error;
            }
        }

        function renderChatMessage(message) {
            const bubble = document.createElement('div');
            bubble.classList.add('p-3', 'rounded-lg', 'max-w-xs');
            if (message.role === 'user') {
                bubble.classList.add('bg-sky-600', 'text-white', 'ml-auto');
            } else {
                bubble.classList.add('bg-slate-700', 'text-slate-200', 'mr-auto');
            }
            bubble.textContent = message.parts[0].text || message.parts; // Handle both history and new messages
            chatHistoryContainer.appendChild(bubble);
            chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
        }

        async function callGeminiApi(userMessage) {
            const geminiApiKey = localStorage.getItem('geminiApiKey');
            if (!geminiApiKey) {
                renderChatMessage({ role: 'model', parts: [{ text: 'Error: Gemini API Key is missing. Please set it in Settings.' }] });
                return;
            }

            loadingIndicator.classList.remove('hidden');

            // Truncate history to keep it manageable
            const truncatedHistory = conversationHistory.slice(-10).map(msg => ({
                ...msg,
                 parts: [{text: msg.parts[0].text || msg.parts }]
            }));

            const requestBody = {
                contents: [
                    ...truncatedHistory,
                    { role: 'user', parts: [{ text: userMessage }] }
                ],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            try {
                const data = await fetchWithBackoff(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const responseText = data.candidates[0].content.parts[0].text;
                const responseObject = JSON.parse(responseText);

                // Add AI response to history and save
                const modelMessage = { role: 'model', parts: [{ text: responseObject.responseMessage }] };
                conversationHistory.push(modelMessage);
                saveChatMessage(modelMessage);
                renderChatMessage(modelMessage);

                // Process tasks if any
                if (responseObject.tasks && responseObject.tasks.length > 0) {
                    for (const task of responseObject.tasks) {
                        await addTask(task);
                    }
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                const errorMessage = { role: 'model', parts: [{ text: 'Sorry, I encountered an error. Please try again.' }] };
                renderChatMessage(errorMessage);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessageText = chatInput.value.trim();
            if (!userMessageText) return;

            const userMessage = { role: 'user', parts: [{ text: userMessageText }] };
            conversationHistory.push(userMessage);
            saveChatMessage(userMessage);
            renderChatMessage(userMessage);

            chatInput.value = '';

            await callGeminiApi(userMessageText);
        });

        // --- 7. APP INITIALIZATION ---

        /**
         * Main application initializer.
         * Loads credentials, initializes Firebase, and sets up the auth state listener.
         */
        function initApp() {
            setLanguage(currentLanguage); // Set initial language on load
            const { firebaseConfig, geminiApiKey } = loadCredentials();

            if (!firebaseConfig || !geminiApiKey) {
                showAuth();
                switchTab('settings'); // Force user to settings if keys are missing
                authError.textContent = 'Please provide Firebase Config and Gemini API Key.';
                authError.classList.remove('hidden');
                // Populate inputs if they exist, for user convenience
                if(firebaseConfig) firebaseConfigInput.value = JSON.stringify(firebaseConfig, null, 2);
                if(geminiApiKey) geminiApiKeyInput.value = geminiApiKey;
                return;
            }

            // Populate settings fields for transparency
            firebaseConfigInput.value = JSON.stringify(firebaseConfig, null, 2);
            geminiApiKeyInput.value = geminiApiKey;

            if (initializeFirebaseApp(firebaseConfig)) {
                onAuthStateChanged(auth, user => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        currentUser = user;
                        showApp();
                        getTasks();
                        getChatHistory();
                    } else {
                        console.log("User is signed out.");
                        showAuth();
                    }
                });
            } else {
                 showAuth(); // Keep auth modal visible if Firebase init fails
            }
        }

        // Run the app
        initApp();

    </script>

</body>
</html>
